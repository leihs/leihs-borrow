#!/usr/bin/env ruby

require 'bundler/inline'
gemfile do
  source 'https://rubygems.org'
  gem 'git', '= 1.9.1'
  gem 'pry', '= 0.14.1'
  gem 'activesupport', '= 5.2.4.5'
end

require 'active_support/all'
require 'date'
require 'git'
require 'pathname'
require 'pry'
require 'socket'
require 'yaml'

__file__ = __FILE__
script = Pathname(__file__)

PROJECT_DIR = Pathname(File.expand_path(File.dirname(__FILE__))).join('..')

project = Git.open(PROJECT_DIR)
current_commit_id = project.log[0].sha
head = project.object('HEAD')
current_tree_id = head.gtree.objectish

# binding.pry

IO.write(PROJECT_DIR.join("resources").join("built-info.yml"),
         {commit_id: current_commit_id,
          hostname: Socket.gethostname,
          os: Gem::Platform.local.to_s,
          timestamp: DateTime.now.iso8601,
          tree_id: current_tree_id, }.with_indifferent_access.to_h.to_yaml)



