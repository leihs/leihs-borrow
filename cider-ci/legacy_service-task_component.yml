git_options:
  submodules:
    include_match: ^.*$

include:
  - path: cider-ci/shared/legacy-ruby_env.yml
    submodule: [spec/support/legacy-api]
  - path: cider-ci/task-components/bundle-rspec-ruby.yml
    submodule: [spec/support/legacy-api]

scripts:
  legacy-service-configure:
    start_when:
      database-configured:
        script_key: database-configure-rails-db
        states: [passed]
    body: |
      set -eux
      cp database/config/database.yml spec/support/legacy-api/config/

  legacy-service-run:
    timeout: 30 Minutes
    body: |
      set -eux
      cd $LEIHS_LEGACY_DIR
      export PATH=~/.rubies/$LEGACY_RUBY/bin:$PATH
      export RAILS_SERVE_STATIC_FILES=yes
      ruby -S \
      bundle exec puma \
      -e production \
      -t 1:2 \
      -w 2 \
      -b tcp://localhost:${LEIHS_LEGACY_HTTP_PORT}
    start_when:
      database has been created:
        script_key: create-database
        states: [passed]
      gems are bundled:
        script_key: legacy-bundle-rspec-ruby
        states: [passed]
      uberjar has passed: # this is not a real dependency but is to prevent timeout issues
        script_key: build-borrow-uberjar

  legacy-service-stop:
    timeout: 5 Seconds
    body: |
      set -eux
      kill -INT $(lsof -t -wni tcp:${LEIHS_LEGACY_HTTP_PORT})
      sleep 1
    start_when:
      test is in terminal state:
        script_key: test
        states: [aborted, defective, passed, failed, skipped]

  test:
    start_when:
      legacy service is running:
        script_key: legacy-service-run
        states: [executing]
