scripts:

  run_legacy-mock-server:
    start_when:
      bundled:
        script_key: borrow-ruby-bundle
      # the following is not a hard dependency, this ist just not fall
      # into a timeout when building the uberjar taks very long
      the uberjar is ready:
        script_key: borrow-build-uberjar
    timeout: 5 Minutes
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      bundle exec ruby spec/mock/legacy-mock-server.rb -p ${LEIHS_LEGACY_HTTP_PORT}

  legacy-mock-server_is-serving:
    timeout: 30 seconds
    start_when:
      the service is running:
        script_key: run_legacy-mock-server
        states: [executing]
    body: |
      #!/usr/bin/env bash
      set -ux
      until curl --silent --fail -I "http://localhost:${LEIHS_LEGACY_HTTP_PORT}/status" ; do
        sleep 1;
      done

  shutdown_legacy-mock-server:
    timeout: 3 Seconds
    body: |
      #!/usr/bin/env bash
      set -euo pipefail
      kill -INT $(lsof -t -wni tcp:${LEIHS_LEGACY_HTTP_PORT})
      sleep 1
    start_when:
      test is terminal:
        script_key: test
        states: [aborted, defective, passed, failed, skipped]
      we are serving:
        script_key: legacy-mock-server_is-serving
